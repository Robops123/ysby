{"version":3,"sources":["uni-app:///main.js","webpack:///C:/Users/Administrator/Desktop/ysby/ysby/App.vue?5dfb","webpack:///C:/Users/Administrator/Desktop/ysby/ysby/App.vue?74af","webpack:///C:/Users/Administrator/Desktop/ysby/ysby/App.vue?af00","uni-app:///App.vue"],"names":["WebIM","require","conn","closed","curOpenOpt","open","opt","this","reopen","Vue","prototype","$im","$conn","config","productionTip","$getHeight","getHeight","$loading","loading","$msg","msg","$upload","upload","$operateInterceptor","operateInterceptor","$apiPost","request","apiPost","$apiGet","apiGet","$imgBaseUrl","App","mpType","app","$mount","render","staticRenderFns","components","renderjs","component","options","__file"],"mappings":";;;;wEAAA,qBAAmB,wBACnB,sBAGA,oCACA,wC,0uBACA,IAAIA,EAAQC,oBAAQ,IAAe,WAK/BC,EAAO,CACVC,QAAQ,EACRC,WAAY,GACZC,KAHU,SAGLC,GACJC,KAAKH,WAAaE,EAClBN,EAAME,KAAKG,KAAKC,GAChBC,KAAKJ,QAAS,GAEfK,OARU,WASLD,KAAKJ,SAERH,EAAME,KAAKG,KAAKE,KAAKH,YACrBG,KAAKJ,QAAS,KAIjBM,UAAIC,UAAUC,IAAMX,EACpBS,UAAIC,UAAUE,MAAQV,EAGtBO,UAAII,OAAOC,eAAgB,EAC3BL,UAAIC,UAAUK,WAAWC,YACzBP,UAAIC,UAAUO,SAASC,UACvBT,UAAIC,UAAUS,KAAKC,MACnBX,UAAIC,UAAUW,QAAQC,SACtBb,UAAIC,UAAUa,oBAAoBC,qBAClCf,UAAIC,UAAUe,SAASC,UAAQC,QAC/BlB,UAAIC,UAAUkB,QAAQF,UAAQG,OAC9BpB,UAAIC,UAAUoB,YAAY,6CAE1BC,UAAIC,OAAS,MAEb,IAAMC,EAAM,IAAIxB,UAAJ,KACLsB,YAEP,EAAAE,GAAIC,W;;;;2DC9CJ,q9BAA+5B,eAAG,G;;;;;;;;2DCAl6B,uMAAIC,EAAQC,EAAmCC,EAC3CC,EADJ,4JASIC,EAAY,qBACd,aACAJ,EACAC,GACA,EACA,KACA,KACA,MACA,EACAC,EACAC,GAGFC,EAAUC,QAAQC,OAAS,UACZ,aAAAF,E;;;;2DCvBf,yrBAAooB,eAAG,G;;;;0ICCvoB,4BACA,wCACA,iCAEA,8BACA,KACA,K,EACA,CACA,YACA,mBACA,cACA,kBACA,wBACA,aACA,UAEA,+BAMA,OACA,+BACA,sBACA,2BAEA,iCACA,sBAGA,qCACA,iCACA,sBAEA,0CACA,sBAEA,4CACA,sBAGA,wCACA,sBAEA,4CACA,sBAIA,mCACA,0BACA,iBACA,8BACA,iBACA,aACA,sBACA,gCAEA,4CAKA,sBACA,qBACA,yBACA,oBACA,yDACA,IACA,cACA,sCACA,MAEA,8FACA,oBAIA,uBACA,yCAEA,6BACA,uCAEA,oBACA,oCACA,cACA,uBAEA,kBACA,oBAEA,4BACA,mDACA,sCAWA,uBAEA,OADA,4BACA,QACA,kBAEA,MAEA,gBACA,4BACA,OAIA,8DACA,yDAGA,OAFA,+CACA,4BAIA,6CACA,kEACA,4BAEA,MACA,iBACA,aACA,aACA,eAEA,6BACA,MACA,mBACA,aACA,YACA,eAEA,MACA,mCACA,kCACA,MAYA,kBACA,kCACA,qCACA,MAEA,sBACA,uCACA,MAEA,iBACA,qCACA,MAEA,uBACA,qCACA,MAiBA,QACA,QAIA,uBAOA,2BACA,kCACA,GACA,4BAEA,oBACA,UAGA,2BACA,gCACA,IACA,qBACA,4BAEA,oBACA,WAIA,yBACA,8BACA,IACA,qBACA,0BAEA,oBACA,WAWA,0BACA,IACA,qBACA,2BAEA,oBACA,WAIA,2BACA,IACA,qBACA,4BAEA,oBACA,WAIA,6BACA,kCACA,IACA,qBACA,4BAEA,oBACA,WAIA,0BACA,IACA,qBACA,2BAEA,oBACA,WAKA,oBAGA,GAFA,eAEA,2DACA,mEACA,OAUA,OARA,aACA,mDACA,eAEA,cACA,4BAEA,MAIA,wDACA,aACA,+BACA,eAEA,cACA,wBAGA,qDACA,oCAOA,qDACA,iCAEA,yBACA,0CACA,aACA,cACA,YACA,eAEA,0CAqBA,OArVA,WAsVA,yBAEA,kBACA,yBAEA,SAEA,eAFA,WAGA,cACA,aACA,sBAIA,IATA,SASA,GAEA,WACA,2DACA,OACA,KACA,YAEA,4BAGA,eApBA,SAoBA,GACA,yBACA,aACA,qBAEA,IAKA,gBA9BA,WA+BA,wBACA,gBACA,gBAGA,eApCA,SAoCA,GACA,qCACA,iCACA,oCACA,cACA,4BACA,MAMA,OAJA,EADA,SACA,+CAEA,2DAEA,aACA,GACA,4CACA,gCAEA,WArDA,WAqDA,WACA,yDACA,eACA,0BACA,GACA,kBACA,aACA,IACA,kCACA,eACA,yBACA,aACA,WACA,eACA,iBACA,iBACA,oBACA,cACA,kBACA,qCACA,SACA,+DACA,cACA,iBACA,gBACA,iBACA,qBACA,wBACA,WACA,YACA,gBACA,eACA,uBAEA,yBACA,QAEA,YACA,gBACA,uBACA,iBACA,KACA,qBAIA,eACA,UACA,4BAKA,mBACA,UACA,wB","file":"common/main.js","sourcesContent":["import 'uni-pages';import Vue from 'vue'\r\nimport App from './App'\r\n\r\n// js\r\nimport { getHeight,loading,msg,operateInterceptor,upload } from './static/js/common.js'\r\nimport request from './static/js/request.js'\r\nlet WebIM = require(\"utils/WebIM\")[\"default\"];\r\n// css\r\n\r\n\r\n// 环信\r\nlet conn = {\r\n\tclosed: false,\r\n\tcurOpenOpt: {},\r\n\topen(opt) {\r\n\t\tthis.curOpenOpt = opt;\r\n\t\tWebIM.conn.open(opt);\r\n\t\tthis.closed = false;\r\n\t},\r\n\treopen() {\r\n\t\tif (this.closed) {\r\n\t\t\t//this.open(this.curOpenOpt);\r\n\t\t\tWebIM.conn.open(this.curOpenOpt);\r\n\t\t\tthis.closed = false;\r\n\t\t}\r\n\t}\r\n};\r\nVue.prototype.$im = WebIM;\r\nVue.prototype.$conn = conn;\r\n\r\n\r\nVue.config.productionTip = false\r\nVue.prototype.$getHeight=getHeight\r\nVue.prototype.$loading=loading\r\nVue.prototype.$msg=msg\r\nVue.prototype.$upload=upload\r\nVue.prototype.$operateInterceptor=operateInterceptor\r\nVue.prototype.$apiPost=request.apiPost\r\nVue.prototype.$apiGet=request.apiGet\r\nVue.prototype.$imgBaseUrl='http://192.168.1.157/yishuban2/attachment/'\r\n\r\nApp.mpType = 'app'\r\n\r\nconst app = new Vue({\r\n    ...App\r\n})\r\napp.$mount()","import mod from \"-!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./App.vue?vue&type=style&index=0&lang=css&\"; export default mod; export * from \"-!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./App.vue?vue&type=style&index=0&lang=css&\"","var render, staticRenderFns, recyclableRender, components\nvar renderjs\nimport script from \"./App.vue?vue&type=script&lang=js&\"\nexport * from \"./App.vue?vue&type=script&lang=js&\"\nimport style0 from \"./App.vue?vue&type=style&index=0&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"App.vue\"\nexport default component.exports","import mod from \"-!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./App.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../hbuilderX/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./App.vue?vue&type=script&lang=js&\"","<script>\r\n\trequire(\"sdk/libs/strophe\");\r\n\tlet msgStorage = require(\"comps/chat/msgstorage\");\r\n\tlet msgType = require(\"comps/chat/msgtype\");\r\n\t\r\n\tlet disp = require(\"utils/broadcast\");\r\n\tlet logout = false;\r\n\tlet is_reconnect = false;\r\n\texport default {\r\n\t\tglobalData: {\r\n\t\t\tunReadMessageNum: 0,\r\n\t\t\tuserInfo: null,\r\n\t\t\tsaveFriendList: [],\r\n\t\t\tsaveGroupInvitedList: [],\r\n\t\t\tgroupList: [],\r\n\t\t\tisIPX: false //是否为iphone X\r\n\t\t},\r\n\t\tonLaunch: function() {\r\n\t\r\n\t\t\t// #ifdef APP-PLUS\r\n\t\t\tthis.updateTest()\r\n\t\t\t// #endif\r\n\t\r\n\t\t\tvar me = this;\r\n\t\t\tvar logs = uni.getStorageSync(\"logs\") || [];\r\n\t\t\tlogs.unshift(Date.now());\r\n\t\t\tuni.setStorageSync(\"logs\", logs);\r\n\t\t\t\r\n\t\t\tdisp.on(\"em.main.ready\", function(){\r\n\t\t\t\tme.calcUnReadSpot();\r\n\t\t\t});\r\n\t\t\t//离开chatroom\r\n\t\t\tdisp.on(\"em.chatroom.leave\", function(){\r\n\t\t\t\tconsole.log('em.chatroom.leave');\r\n\t\t\t\tme.calcUnReadSpot();\r\n\t\t\t});\r\n\t\t\tdisp.on(\"em.chat.session.remove\", function(){\r\n\t\t\t\tme.calcUnReadSpot();\r\n\t\t\t});\r\n\t\t\tdisp.on('em.chat.audio.fileLoaded', function(){\r\n\t\t\t\tme.calcUnReadSpot()\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tdisp.on('em.main.deleteFriend', function(){\r\n\t\t\t\tme.calcUnReadSpot()\r\n\t\t\t});\r\n\t\t\tdisp.on('em.chat.audio.fileLoaded', function(){\r\n\t\t\t\tme.calcUnReadSpot()\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar userInfo = uni.getStorageSync('userInfo')\r\n\t\t\tif(userInfo!='' & userInfo!=null & userInfo!=undefined){\r\n\t\t\t\tthis.$conn.open({\r\n\t\t\t\t\t\t\t\t\t\t\tapiUrl: this.$im.config.apiURL,\r\n\t\t\t\t\t\t\t\t\t\t\tuser: userInfo.hx_openid,\r\n\t\t\t\t\t\t\t\t\t\t\tpwd: userInfo.hx_pwd,\r\n\t\t\t\t\t\t\t\t\t\t\tgrant_type: 'password',\r\n\t\t\t\t\t\t\t\t\t\t\tappKey: this.$im.config.appkey\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\tuni.setStorageSync('myUsername',userInfo.hx_openid)\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tthis.$im.conn.listen({\r\n\t\t\t\tonOpened: (message)=>{\r\n\t\t\t\t\tthis.$im.conn.setPresence();\r\n\t\t\t\t\tconsole.log('登录成功');\r\n\t\t\t\t\tmessage.accessToken && uni.setStorageSync(\"myToken\", message.accessToken);\r\n\t\t\t\t\tif (is_reconnect) {\r\n\t\t\t\t\t\tuni.hideToast();\r\n\t\t\t\t\t\tthis.$helper.toast('success', '登陆成功', 2000)\r\n\t\t\t\t\t\tis_reconnect = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(this.getCurrentRoute() == \"pages/login/login\" || getCurrentRoute() == \"pages/login_token/login_token\"){\r\n\t\t\t\t\t\tthis.onLoginSuccess();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t},\r\n\t\t\t\tonReconnect: ()=>{\r\n\t\t\t\t\tthis.$helper.toast('loading', '重连中...', 2000)\r\n\t\t\t\t},\r\n\t\t\t\tonSocketConnected: ()=>{\r\n\t\t\t\t\tthis.$helper.toast('success', '登陆成功', 2000)\r\n\t\t\t\t},\r\n\t\t\t\tonClosed: ()=>{\r\n\t\t\t\t\tthis.$helper.toast('none', '网络已断开', 2000)\r\n\t\t\t\t\tuni.redirectTo({\r\n\t\t\t\t\t\turl: \"../login/login\"\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.$conn.closed = true;\r\n\t\t\t\t\tthis.$im.conn.close();\r\n\t\t\t\t},\r\n\t\t\t\tonInviteMessage: (message)=>{\r\n\t\t\t\t\tthis.$options.globalData.saveGroupInvitedList.push(message);\r\n\t\t\t\t\tdisp.fire(\"em.xmpp.invite.joingroup\", message);\r\n\t\t\t\t\t// uni.showModal({\r\n\t\t\t\t\t// \ttitle: message.from + \" 已邀你入群 \" + message.roomid,\r\n\t\t\t\t\t// \tsuccess(){\r\n\t\t\t\t\t// \t\tdisp.fire(\"em.xmpp.invite.joingroup\", message);\r\n\t\t\t\t\t// \t},\r\n\t\t\t\t\t// \terror(){\r\n\t\t\t\t\t// \t\tdisp.fire(\"em.xmpp.invite.joingroup\", message);\r\n\t\t\t\t\t// \t}\r\n\t\t\t\t\t// });\r\n\t\t\t\t},\r\n\t\t\t\tonPresence: (message)=>{\r\n\t\t\t\t\tconsole.log(\"onPresence\", message);\r\n\t\t\t\t\tswitch(message.type){\r\n\t\t\t\t\tcase \"unsubscribe\":\r\n\t\t\t\t\t\t// pages[0].moveFriend(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t// 好友邀请列表\r\n\t\t\t\t\tcase \"subscribe\":\r\n\t\t\t\t\t\tif(message.status === \"[resp:true]\"){\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t// pages[0].handleFriendMsg(message);\r\n\t\t\t\t\t\t\tfor (let i = 0; i < this.$options.globalData.saveFriendList.length; i ++) {\r\n\t\t\t\t\t\t      \tif(this.$options.globalData.saveFriendList[i].from === message.from){\r\n\t\t\t\t\t\t      \t\tthis.$options.globalData.saveFriendList[i] = message\r\n\t\t\t\t\t\t      \t\tdisp.fire(\"em.xmpp.subscribe\");\r\n\t\t\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t \t\t}\r\n\t\t\t\t\t\t    }\r\n\t\t\t\t\t\t\tthis.$options.globalData.saveFriendList.push(message);\r\n\t\t\t\t\t\t\tconsole.log(JSON.stringify(this.$options.globalData.saveFriendList));\r\n\t\t\t\t\t\t\tdisp.fire(\"em.xmpp.subscribe\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"subscribed\":\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: \"添加成功\",\r\n\t\t\t\t\t\t\tduration: 1000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.subscribed\");\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"unsubscribed\":\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: \"已拒绝\",\r\n\t\t\t\t\t\t\tduration: 1000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"memberJoinPublicGroupSuccess\":\r\n\t\t\t\t\t\tthis.$helper.toast('none', '已进群', 1000)\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t// 好友列表\r\n\t\t\t\t\t// case \"subscribed\":\r\n\t\t\t\t\t// \tlet newFriendList = [];\r\n\t\t\t\t\t// \tfor(let i = 0; i < me.$options.globalData.saveFriendList.length; i++){\r\n\t\t\t\t\t// \t\tif(me.$options.globalData.saveFriendList[i].from != message.from){\r\n\t\t\t\t\t// \t\t\tnewFriendList.push(me.$options.globalData.saveFriendList[i]);\r\n\t\t\t\t\t// \t\t}\r\n\t\t\t\t\t// \t}\r\n\t\t\t\t\t// \tme.$options.globalData.saveFriendList = newFriendList;\r\n\t\t\t\t\t// \tbreak;\r\n\t\t\t\t\t// 删除好友\r\n\t\t\t\t\tcase \"unavailable\":\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.contacts.remove\");\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.group.leaveGroup\", message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\r\n\t\t\t\t\tcase 'deleteGroupChat':\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.invite.deleteGroup\", message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\r\n\t\t\t\t\tcase \"leaveGroup\": \r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.group.leaveGroup\", message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\r\n\t\t\t\t\tcase \"removedFromGroup\": \r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.group.leaveGroup\", message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t// case \"joinChatRoomSuccess\":\r\n\t\t\t\t\t// \tuni.showToast({\r\n\t\t\t\t\t// \t\ttitle: \"JoinChatRoomSuccess\",\r\n\t\t\t\t\t// \t});\r\n\t\t\t\t\t// \tbreak;\r\n\t\t\t\t\t// case \"memberJoinChatRoomSuccess\":\r\n\t\t\t\t\t// \tuni.showToast({\r\n\t\t\t\t\t// \t\ttitle: \"memberJoinChatRoomSuccess\",\r\n\t\t\t\t\t// \t});\r\n\t\t\t\t\t// \tbreak;\r\n\t\t\t\t\t// case \"memberLeaveChatRoomSuccess\":\r\n\t\t\t\t\t// \tuni.showToast({\r\n\t\t\t\t\t// \t\ttitle: \"leaveChatRoomSuccess\",\r\n\t\t\t\t\t// \t});\r\n\t\t\t\t\t// \tbreak;\r\n\t\t\t\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonRoster: (message)=>{\r\n\t\t\t\t\t// let pages = getCurrentPages();\r\n\t\t\t\t\t// if(pages[0]){\r\n\t\t\t\t\t// \tpages[0].onShow();\r\n\t\t\t\t\t// }\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonVideoMessage: (message)=>{\r\n\t\t\t\t\tconsole.log(\"onVideoMessage: \", message);\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.VIDEO);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonAudioMessage: (message)=>{\r\n\t\t\t\t\tconsole.log(\"onAudioMessage\", message);\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.AUDIO);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t\r\n\t\t\t\tonCmdMessage: (message)=>{\r\n\t\t\t\t\tconsole.log(\"onCmdMessage\", message);\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.CMD);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\t// onLocationMessage: (message)=>{\r\n\t\t\t\t// \tconsole.log(\"Location message: \", message);\r\n\t\t\t\t// \tif(message){\r\n\t\t\t\t// \t\tmsgStorage.saveReceiveMsg(message, msgType.LOCATION);\r\n\t\t\t\t// \t}\r\n\t\t\t\t// },\r\n\t\t\t\r\n\t\t\t\tonTextMessage: (message)=>{\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.TEXT);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonEmojiMessage: (message)=>{\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.EMOJI);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonPictureMessage: (message)=>{\r\n\t\t\t\t\tconsole.log(\"onPictureMessage\", message);\r\n\t\t\t\t\tif(message){\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.IMAGE);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\tonFileMessage: (message)=>{\r\n\t\t\t\t\tif (message) {\r\n\t\t\t\t\t\tif(this.onMessageError(message)){\r\n\t\t\t\t\t\t\tmsgStorage.saveReceiveMsg(message, msgType.FILE);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.calcUnReadSpot(message);\r\n\t\t\t\t\t\tthis.ack(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\r\n\t\t\t\t// 各种异常\r\n\t\t\t\tonError: (error)=>{\r\n\t\t\t\t\tconsole.log(error)\r\n\t\t\t\t\t// 16: server-side close the websocket connection\r\n\t\t\t\t\tif(error.type == this.$im.statusCode.WEBIM_CONNCTION_DISCONNECTED && !logout){\r\n\t\t\t\t\t\tif(this.$im.conn.autoReconnectNumTotal < this.$im.conn.autoReconnectNumMax){\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: \"server-side close the websocket connection\",\r\n\t\t\t\t\t\t\tduration: 1000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tuni.redirectTo({\r\n\t\t\t\t\t\t\turl: \"../login/login\"\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tlogout = true\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// 8: offline by multi login\r\n\t\t\t\t\tif(error.type == this.$im.statusCode.WEBIM_CONNCTION_SERVER_ERROR){\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: \"offline by multi login\",\r\n\t\t\t\t\t\t\tduration: 1000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tuni.redirectTo({\r\n\t\t\t\t\t\t\turl: \"../login/login\"\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(error.type ==  this.$im.statusCode.WEBIM_CONNCTION_OPEN_ERROR){\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.error.passwordErr\");\r\n\t\t\t\t\t\t// uni.showModal({\r\n\t\t\t\t\t\t// \ttitle: \"用户名或密码错误\",\r\n\t\t\t\t\t\t// \tconfirmText: \"OK\",\r\n\t\t\t\t\t\t// \tshowCancel: false\r\n\t\t\t\t\t\t// });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (error.type == this.$im.statusCode.WEBIM_CONNCTION_AUTH_ERROR) {\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.error.tokenErr\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (error.type == 'socket_error') {///sendMsgError\r\n\t\t\t\t\t\tconsole.log('socket_errorsocket_error', error)\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: \"网络已断开\",\r\n\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\tduration: 2000\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tdisp.fire(\"em.xmpp.error.sendMsgErr\", error);\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t// // #ifdef H5\r\n\t\t\t// if(!this.$im.conn.isOpened() && uni.getStorageSync(\"myToken\") && uni.getStorageSync(\"myUsername\")) {\r\n\t\t\t// \tis_reconnect = true;\r\n\t\t\t// \tthis.$helper.toast('loading', '自动登陆中...', 10000, true);\r\n\t\t\t// \t//尝试使用token重新登陆\r\n\t\t\t// \tthis.$conn.open({\r\n\t\t\t// \t\tapiUrl: this.$im.config.apiURL,\r\n\t\t\t// \t\tuser: uni.getStorageSync(\"myUsername\"),\r\n\t\t\t// \t\taccessToken: uni.getStorageSync(\"myToken\"),\r\n\t\t\t// \t\tappKey: this.$im.config.appkey\r\n\t\t\t// \t});\r\n\t\t\t// }\r\n\t\t\t// // #endif\r\n\t\t\t\r\n\t\t\t\r\n\t\t},\r\n\t\tonShow() {\r\n\t\t\tconsole.log('App Show')\r\n\t\t},\r\n\t\tonHide: function() {\r\n\t\t\tconsole.log('App Hide')\r\n\t\t},\r\n\t\tmethods: {\r\n\t\r\n\t\t\tonLoginSuccess(){\r\n\t\t\t\tuni.hideToast();\r\n\t\t\t\tuni.switchTab({\r\n\t\t\t\t\turl: \"../chat/chat\"\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tack(receiveMsg){\r\n\t\t\t\t// 处理未读消息回执\r\n\t\t\t\tvar bodyId = receiveMsg.id;         // 需要发送已读回执的消息id\r\n\t\t\t\tvar ackMsg = new this.$im.message(\"read\", this.$im.conn.getUniqueId());\r\n\t\t\t\tackMsg.set({\r\n\t\t\t\t\tid: bodyId,\r\n\t\t\t\t\tto: receiveMsg.from\r\n\t\t\t\t});\r\n\t\t\t\tthis.$im.conn.send(ackMsg.body);\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tonMessageError(err){\r\n\t\t\t\tif(err.type === \"error\"){\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: err.errorText\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tgetCurrentRoute(){\r\n\t\t\t\tlet pages = getCurrentPages();\r\n\t\t\t\tlet currentPage = pages[pages.length - 1];\r\n\t\t\t\treturn currentPage.route;\r\n\t\t\t},\r\n\t\t\t\r\n\t\t\tcalcUnReadSpot(message){\r\n\t\t\t\tlet myName = uni.getStorageSync(\"myUsername\");\r\n\t\t\t\tlet members = uni.getStorageSync(\"member\") || []; //好友\r\n\t\t\t\tvar listGroups = uni.getStorageSync('listGroup')|| []; //群组\r\n\t\t\t\tlet allMembers = members.concat(listGroups)\r\n\t\t\t\tlet count = allMembers.reduce(function(result, curMember, idx){\r\n\t\t\t\t\tlet chatMsgs;\r\n\t\t\t\t\tif (curMember.roomId) {\r\n\t\t\t\t\t\tchatMsgs = uni.getStorageSync(curMember.roomId + myName.toLowerCase()) || [];\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tchatMsgs = uni.getStorageSync(curMember.name.toLowerCase() + myName.toLowerCase()) || [];\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn result + chatMsgs.length;\r\n\t\t\t\t}, 0);\r\n\t\t\t\tthis.$options.globalData.unReadMessageNum = count;\r\n\t\t\t\tdisp.fire(\"em.xmpp.unreadspot\", message);\r\n\t\t\t},\r\n\t\t\tupdateTest(){\r\n\t\t\t\tplus.runtime.getProperty(plus.runtime.appid,(widgetInfo) =>{\r\n\t\t\t\t\tconsole.log(widgetInfo)\r\n\t\t\t\t\tvar url='&r=api.update.hot',\r\n\t\t\t\t\tparams={\r\n\t\t\t\t\t\tversion:widgetInfo.version,\r\n\t\t\t\t\t\tname:widgetInfo.name \r\n\t\t\t\t\t},that=this\r\n\t\t\t\t\tthis.$apiPost(url,params).then((res) =>{\r\n\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t\tif(res.update==\"1\" && res.wgtUrl){\r\n\t\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\t\ttitle:'提示',\r\n\t\t\t\t\t\t\t\tcontent:'可以更新',\r\n\t\t\t\t\t\t\t\tconfirmText:'更新',\r\n\t\t\t\t\t\t\t\tcancelText:'不更新',\r\n\t\t\t\t\t\t\t\tsuccess: (cres) => {\r\n\t\t\t\t\t\t\t\t        if (cres.confirm) {\r\n\t\t\t\t\t\t\t\t            that.$loading('下载中')\r\n\t\t\t\t\t\t\t\t var task=plus.downloader.createDownload(\r\n\t\t\t\t\t\t\t\t            \tres.wgtUrl,\r\n\t\t\t\t\t\t\t\t            \t{filename:'_doc/update/' + widgetInfo.name + '/' + new Date().getTime() + '/'},\r\n\t\t\t\t\t\t\t\t            \tfunction(result,code){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log(result,code)\r\n\t\t\t\t\t\t\t\t            \t\tuni.hideLoading()\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tlet filePath = result.filename;\r\n\t\t\t\t\t\t\t\t            \t\tthat.$loading('安装中...')\r\n\t\t\t\t\t\t\t\t            \t\t                       plus.runtime.install(filePath, {  \r\n\t\t\t\t\t\t\t\t            \t\t                           force: false  \r\n\t\t\t\t\t\t\t\t            \t\t                       }, function(e) {  \r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   uni.hideLoading()\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   console.log(e)\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   setTimeout(() =>{\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t\t   // that.$msg('安装成功，等待重启')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   plus.runtime.restart(); \r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   },200)\r\n\t\t\t\t\t\t\t\t            \t\t                            \r\n\t\t\t\t\t\t\t\t            \t\t                       }, function(e) {  \r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   uni.hideLoading()\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   setTimeout(() =>{\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t\t   that.$msg('安装失败')\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   },200)\r\n\t\t\t\t\t\t\t\t            \t\t\t\t\t\t\t\t   console.log(e)\r\n\t\t\t\t\t\t\t\t            \t\t                       });  \r\n\t\t\t\t\t\t\t\t            \t}\r\n\t\t\t\t\t\t\t\t            )\r\n\t\t\t\t\t\t\t\t\t\t\ttask.start()\r\n\t\t\t\t\t\t\t\t        } else if (cres.cancel) {\r\n\t\t\t\t\t\t\t\t            console.log('用户点击取消');\r\n\t\t\t\t\t\t\t\t        }\r\n\t\t\t\t\t\t\t\t    }\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}).catch((reason) =>{\r\n\t\t\t\t\t\tthis.$msg(reason)\r\n\t\t\t\t\t\tconsole.log(reason)\r\n\t\t\t\t\t})\r\n\t\t\t\t\t // uni.request({  \r\n\t\t\t\t\t //        url: 'http://www.example.com/update/',  \r\n\t\t\t\t\t //        data: {  \r\n\t\t\t\t\t //            version: widgetInfo.version,  \r\n\t\t\t\t\t //            name: widgetInfo.name  \r\n\t\t\t\t\t //        },  \r\n\t\t\t\t\t //        success: (result) => {  \r\n\t\t\t\t\t //            var data = result.data;  \r\n\t\t\t\t\t //            if (data.update && data.wgtUrl) {  \r\n\t\t\t\t\t //                uni.downloadFile({  \r\n\t\t\t\t\t //                    url: data.wgtUrl,  \r\n\t\t\t\t\t //                    success: (downloadResult) => {  \r\n\t\t\t\t\t //                        if (downloadResult.statusCode === 200) {  \r\n\t\t\t\t\t //                            plus.runtime.install(downloadResult.tempFilePath, {  \r\n\t\t\t\t\t //                                force: false  \r\n\t\t\t\t\t //                            }, function() {  \r\n\t\t\t\t\t //                                console.log('install success...');  \r\n\t\t\t\t\t //                                plus.runtime.restart();  \r\n\t\t\t\t\t //                            }, function(e) {  \r\n\t\t\t\t\t //                                console.error('install fail...');  \r\n\t\t\t\t\t //                            });  \r\n\t\t\t\t\t //                        }  \r\n\t\t\t\t\t //                    }  \r\n\t\t\t\t\t //                });  \r\n\t\t\t\t\t //            }  \r\n\t\t\t\t\t //        }  \r\n\t\t\t\t\t //    });  \r\n\t\t\t\t})\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t},\r\n\t}\r\n</script>\r\n\r\n<style>\r\n@import \"./static/css/iconfont.css\";\r\n\t@import './static/css/common.css';\r\n\t@import './static/css/animate.css';\r\n\t/* @import url(\"/components/gaoyia-parse/parse.css\"); */\r\n\r\n\t\r\n\t\r\n\t\r\n</style>\n"],"sourceRoot":""}